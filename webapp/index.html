<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>FinBot — Add Expense</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    background: var(--tg-theme-bg-color, #fff);
    color: var(--tg-theme-text-color, #000);
    padding: 16px 16px 100px;
    -webkit-font-smoothing: antialiased;
  }

  /* ── Access denied screen ─────────────────────── */
  .blocked {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 60vh;
    text-align: center;
    padding: 40px 20px;
  }
  .blocked .lock-icon { font-size: 48px; margin-bottom: 16px; }
  .blocked h2 {
    font-size: 20px;
    font-weight: 700;
    margin: 0 0 8px;
    color: var(--tg-theme-text-color, #000);
    text-transform: none;
    letter-spacing: 0;
  }
  .blocked p {
    font-size: 15px;
    color: var(--tg-theme-hint-color, #999);
    line-height: 1.5;
  }

  .screen { display: none; }
  .screen.active { display: block; }

  h2 {
    font-size: 15px;
    font-weight: 600;
    margin: 20px 0 8px;
    color: var(--tg-theme-hint-color, #999);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  /* ── Empty-state message ──────────────────────── */
  .empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 40px 20px;
    min-height: 40vh;
  }
  .empty-state .empty-icon { font-size: 48px; margin-bottom: 14px; }
  .empty-state p {
    font-size: 15px;
    color: var(--tg-theme-hint-color, #999);
    line-height: 1.5;
  }

  /* ── Category grid (landing screen) ───────────── */
  .cat-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
  }
  .cat-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: var(--tg-theme-secondary-bg-color, #f0f0f0);
    border: 2px solid transparent;
    border-radius: 16px;
    padding: 16px 6px 14px;
    cursor: pointer;
    transition: transform 0.12s ease, box-shadow 0.12s ease;
    -webkit-tap-highlight-color: transparent;
  }
  .cat-card:active { transform: scale(0.95); }
  .cat-card .icon-wrap {
    width: 52px;
    height: 52px;
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 8px;
  }
  .cat-card .icon-wrap .icon { font-size: 26px; line-height: 1; }
  .cat-card .label {
    font-size: 11px;
    font-weight: 600;
    text-transform: capitalize;
    color: var(--tg-theme-text-color, #000);
    text-align: center;
    line-height: 1.25;
    max-width: 100%;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  /* ── Form screen header ───────────────────────── */
  .form-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 8px;
    padding: 14px 16px;
    background: var(--tg-theme-secondary-bg-color, #f0f0f0);
    border-radius: 14px;
  }
  .form-header .icon-wrap {
    width: 44px;
    height: 44px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }
  .form-header .icon-wrap .icon { font-size: 22px; line-height: 1; }
  .form-header .name {
    font-size: 17px;
    font-weight: 600;
    text-transform: capitalize;
  }

  /* ── Inputs ────────────────────────────────────── */
  .field { margin-top: 8px; }
  .input-row {
    display: flex;
    gap: 8px;
    align-items: center;
  }
  input[type="number"],
  input[type="text"],
  input[type="date"] {
    width: 100%;
    background: var(--tg-theme-secondary-bg-color, #f0f0f0);
    color: var(--tg-theme-text-color, #000);
    border: 1.5px solid transparent;
    border-radius: 10px;
    padding: 12px 14px;
    font-size: 16px;
    outline: none;
    transition: border-color 0.15s;
    -webkit-appearance: none;
  }
  input:focus {
    border-color: var(--tg-theme-button-color, #3390ec);
  }
  input::placeholder {
    color: var(--tg-theme-hint-color, #999);
  }

  /* ── Segmented controls ────────────────────────── */
  .seg-control {
    display: flex;
    background: var(--tg-theme-secondary-bg-color, #f0f0f0);
    border-radius: 10px;
    padding: 3px;
    gap: 3px;
  }
  .seg-btn {
    flex: 1;
    background: transparent;
    color: var(--tg-theme-text-color, #000);
    border: none;
    border-radius: 8px;
    padding: 9px 6px;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s ease;
    -webkit-tap-highlight-color: transparent;
  }
  .seg-btn.selected {
    background: var(--tg-theme-button-color, #3390ec);
    color: var(--tg-theme-button-text-color, #fff);
    box-shadow: 0 1px 3px rgba(0,0,0,0.12);
  }

  /* ── Custom split inputs ───────────────────────── */
  .custom-split {
    display: none;
    gap: 8px;
    margin-top: 8px;
    align-items: center;
  }
  .custom-split.visible { display: flex; }
  .custom-split input {
    flex: 1;
    text-align: center;
  }
  .custom-split span {
    font-size: 14px;
    font-weight: 600;
    color: var(--tg-theme-hint-color, #999);
  }

  /* ── Validation hint ───────────────────────────── */
  .hint {
    text-align: center;
    color: var(--tg-theme-hint-color, #999);
    font-size: 13px;
    margin-top: 24px;
    padding: 0 16px;
  }

</style>
</head>
<body>

<!-- ── Access denied (shown when not opened from Telegram) ── -->
<div class="blocked" id="blockedScreen">
  <div class="lock-icon">&#x1F512;</div>
  <h2>Access Denied</h2>
  <p>This app can only be used from within Telegram.<br>Open the bot and tap <b>/add</b> to get started.</p>
</div>

<!-- ── Screen 1: Category grid ─────────────────────────────── -->
<div class="screen" id="categoryScreen">
  <h2>Choose a category</h2>
  <div class="cat-grid" id="catGrid"></div>
  <div class="empty-state" id="emptyState" style="display:none">
    <div class="empty-icon">&#x1F4AD;</div>
    <p>No categories loaded.<br>Go back to the bot and tap <b>/add</b> again.</p>
  </div>
</div>

<!-- ── Screen 2: Expense form ──────────────────────────────── -->
<div class="screen" id="formScreen">
  <div class="form-header" id="formHeader">
    <div class="icon-wrap" id="formHeaderIconWrap">
      <span class="icon" id="formHeaderIcon"></span>
    </div>
    <span class="name" id="formHeaderName"></span>
  </div>

  <h2>Amount</h2>
  <div class="field">
    <div class="input-row">
      <input type="number" id="amount" inputmode="decimal" placeholder="0.00" min="0" step="any">
    </div>
  </div>

  <h2>Description</h2>
  <div class="field">
    <input type="text" id="description" placeholder="Optional label" autocomplete="off">
  </div>

  <h2>Who paid?</h2>
  <div class="seg-control" id="payerControl">
    <button class="seg-btn selected" data-value="user">I paid</button>
    <button class="seg-btn" data-value="partner">Partner paid</button>
  </div>

  <h2>Split</h2>
  <div class="seg-control" id="splitControl">
    <button class="seg-btn selected" data-value="50">50 / 50</button>
    <button class="seg-btn" data-value="100">100 / 0</button>
    <button class="seg-btn" data-value="custom">Custom</button>
  </div>
  <div class="custom-split" id="customSplit">
    <input type="number" id="splitPayer" inputmode="numeric" placeholder="Payer %" min="0" max="100" value="50">
    <span>/</span>
    <input type="number" id="splitOther" inputmode="numeric" placeholder="Other %" min="0" max="100" value="50">
  </div>

  <h2>Date</h2>
  <div class="field">
    <input type="date" id="eventDate">
  </div>

  <p class="hint" id="hint">Enter an amount to continue.</p>
</div>

<script>
(function() {
  var tg = window.Telegram.WebApp;
  tg.ready();

  document.getElementById('blockedScreen').style.display = 'none';
  tg.expand();

  // API base: passed via ?api= param, or same origin if served locally
  var params = new URLSearchParams(window.location.search);
  var API_BASE = params.get('api') || window.location.origin;

  // ── Category icon + colour map ────────────────────
  var CATS = {
    clothing:       { icon: "\uD83D\uDC55",       bg: "#fce4ec" },
    coffee:         { icon: "\u2615",              bg: "#efebe9" },
    dining:         { icon: "\uD83C\uDF7D\uFE0F", bg: "#fff3e0" },
    education:      { icon: "\uD83C\uDF93",       bg: "#e8eaf6" },
    entertainment:  { icon: "\uD83C\uDFAC",       bg: "#f3e5f5" },
    gas:            { icon: "\u26FD",              bg: "#fff9c4" },
    gifts:          { icon: "\uD83C\uDF81",       bg: "#fce4ec" },
    groceries:      { icon: "\uD83D\uDED2",       bg: "#e8f5e9" },
    health:         { icon: "\uD83C\uDFE5",       bg: "#e3f2fd" },
    home:           { icon: "\uD83C\uDFE0",       bg: "#e0f2f1" },
    insurance:      { icon: "\uD83D\uDEE1\uFE0F", bg: "#e8eaf6" },
    personal:       { icon: "\uD83D\uDC87",       bg: "#fce4ec" },
    pharmacy:       { icon: "\uD83D\uDC8A",       bg: "#e1f5fe" },
    rent:           { icon: "\uD83C\uDFE2",       bg: "#ede7f6" },
    subscriptions:  { icon: "\uD83D\uDCF1",       bg: "#e0f7fa" },
    transport:      { icon: "\uD83D\uDE8C",       bg: "#fff3e0" },
    travel:         { icon: "\u2708\uFE0F",        bg: "#e3f2fd" },
    utilities:      { icon: "\uD83D\uDCA1",       bg: "#fffde7" }
  };
  var DEFAULT_CAT = { icon: "\uD83D\uDCB0", bg: "#f5f5f5" };

  function catInfo(name) {
    return CATS[name.toLowerCase()] || DEFAULT_CAT;
  }

  // ── Read params from URL ────────────────────────────
  var categories = (params.get('cats') || '').split(',').filter(Boolean);
  var currency = params.get('currency') || 'ILS';

  // ── State ──────────────────────────────────────────
  var selectedCat = null;
  var payer = 'user';
  var splitMode = '50';

  var categoryScreen = document.getElementById('categoryScreen');
  var formScreen = document.getElementById('formScreen');

  // ── Screen navigation ──────────────────────────────
  function showCategoryScreen() {
    formScreen.classList.remove('active');
    categoryScreen.classList.add('active');
    tg.BackButton.hide();
    tg.MainButton.hide();
  }

  function showFormScreen() {
    categoryScreen.classList.remove('active');
    formScreen.classList.add('active');

    var info = catInfo(selectedCat);
    var wrap = document.getElementById('formHeaderIconWrap');
    wrap.style.background = info.bg;
    document.getElementById('formHeaderIcon').textContent = info.icon;
    document.getElementById('formHeaderName').textContent = selectedCat;

    tg.BackButton.show();
    validate();
  }

  tg.BackButton.onClick(function() {
    showCategoryScreen();
  });

  // ── Render category grid ───────────────────────────
  var catGrid = document.getElementById('catGrid');
  var emptyState = document.getElementById('emptyState');

  if (categories.length === 0) {
    emptyState.style.display = 'flex';
  } else {
    categories.forEach(function(cat) {
      var info = catInfo(cat);

      var card = document.createElement('button');
      card.className = 'cat-card';

      var iconWrap = document.createElement('div');
      iconWrap.className = 'icon-wrap';
      iconWrap.style.background = info.bg;

      var iconSpan = document.createElement('span');
      iconSpan.className = 'icon';
      iconSpan.textContent = info.icon;
      iconWrap.appendChild(iconSpan);
      card.appendChild(iconWrap);

      var labelSpan = document.createElement('span');
      labelSpan.className = 'label';
      labelSpan.textContent = cat;
      card.appendChild(labelSpan);

      card.addEventListener('click', function() {
        selectedCat = cat;
        showFormScreen();
      });
      catGrid.appendChild(card);
    });
  }

  showCategoryScreen();

  // ── Date default = today ───────────────────────────
  var dateInput = document.getElementById('eventDate');
  var now = new Date();
  dateInput.value = now.getFullYear() + '-' +
    String(now.getMonth() + 1).padStart(2, '0') + '-' +
    String(now.getDate()).padStart(2, '0');

  // ── Segmented control wiring ───────────────────────
  function wireSegControl(id, onChange) {
    var container = document.getElementById(id);
    var buttons = container.querySelectorAll('.seg-btn');
    buttons.forEach(function(btn) {
      btn.addEventListener('click', function() {
        buttons.forEach(function(b) { b.classList.remove('selected'); });
        btn.classList.add('selected');
        onChange(btn.dataset.value);
      });
    });
  }

  wireSegControl('payerControl', function(val) { payer = val; });
  wireSegControl('splitControl', function(val) {
    splitMode = val;
    var el = document.getElementById('customSplit');
    if (val === 'custom') {
      el.classList.add('visible');
    } else {
      el.classList.remove('visible');
    }
    validate();
  });

  var splitPayerInput = document.getElementById('splitPayer');
  var splitOtherInput = document.getElementById('splitOther');
  splitPayerInput.addEventListener('input', function() {
    var v = parseInt(splitPayerInput.value, 10);
    if (!isNaN(v) && v >= 0 && v <= 100) {
      splitOtherInput.value = 100 - v;
    }
    validate();
  });
  splitOtherInput.addEventListener('input', function() {
    var v = parseInt(splitOtherInput.value, 10);
    if (!isNaN(v) && v >= 0 && v <= 100) {
      splitPayerInput.value = 100 - v;
    }
    validate();
  });

  // ── Amount input (validate on input, change, keyup for WebView compatibility) ──
  var amountInput = document.getElementById('amount');
  amountInput.addEventListener('input', validate);
  amountInput.addEventListener('change', validate);
  amountInput.addEventListener('keyup', validate);

  // ── Validation & MainButton ────────────────────────
  var hint = document.getElementById('hint');

  function validate() {
    var amount = parseFloat(amountInput.value);
    var valid = amount > 0;

    if (splitMode === 'custom') {
      var sp = parseInt(splitPayerInput.value, 10);
      var so = parseInt(splitOtherInput.value, 10);
      if (isNaN(sp) || isNaN(so) || sp < 0 || so < 0 || sp + so !== 100) {
        valid = false;
      }
    }

    if (valid) {
      tg.MainButton.setText('Submit \u2014 ' + currency + ' ' + amount.toFixed(2));
      tg.MainButton.show();
      hint.textContent = '';
    } else {
      tg.MainButton.hide();
      hint.textContent = 'Enter a valid amount to continue.';
    }
  }

  // ── Submit via API POST ─────────────────────────────
  tg.MainButton.onClick(function() {
    var splitPayerPct, splitOtherPct;
    if (splitMode === '50') {
      splitPayerPct = 50;
      splitOtherPct = 50;
    } else if (splitMode === '100') {
      splitPayerPct = 100;
      splitOtherPct = 0;
    } else {
      splitPayerPct = parseInt(splitPayerInput.value, 10);
      splitOtherPct = parseInt(splitOtherInput.value, 10);
    }

    var expense = {
      category: selectedCat,
      amount: parseFloat(amountInput.value),
      currency: currency,
      description: document.getElementById('description').value.trim() || null,
      payer: payer,
      split_payer_pct: splitPayerPct,
      split_other_pct: splitOtherPct,
      event_date: dateInput.value || null
    };

    tg.MainButton.showProgress();

    fetch(API_BASE + '/api/expense', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Bypass-Tunnel-Reminder': 'true'
      },
      body: JSON.stringify({
        initData: tg.initData,
        expense: expense
      })
    })
    .then(function(res) { return res.json(); })
    .then(function(result) {
      tg.MainButton.hideProgress();
      if (result.ok) {
        tg.close();
      } else {
        hint.textContent = result.error || 'Submission failed.';
        tg.MainButton.show();
      }
    })
    .catch(function(err) {
      tg.MainButton.hideProgress();
      hint.textContent = 'Network error — check connection.';
      tg.MainButton.show();
    });
  });

  tg.MainButton.setParams({
    color: tg.themeParams.button_color || '#3390ec',
    text_color: tg.themeParams.button_text_color || '#ffffff'
  });
  tg.MainButton.hide();
})();
</script>
</body>
</html>
